{% extends "base.html" %}

{% block title %}Grant Access - AccessPoint{% endblock %}

{% block head_extra %}
    <!-- Pass available groups to JS via data attribute or global var -->
    <script>
      // Make Flask data available globally
      window.csrf_token = "{{ csrf_token() if csrf_token else '' }}"; // If using Flask-WTF
      window.availableGroups = {{ available_groups | tojson }};
    </script>
{% endblock %}


{% block content %}
<div class="form-container">
    <a href="{{ url_for('accesspoint') }}" class="back-link">&larr; Back to AccessPoint</a>
    <h1>Grant Server Access</h1>
    <div id="form-feedback" class="form-feedback" aria-live="polite"></div>

    <form id="give-access-form" action="{{ url_for('create_user') }}" method="POST" novalidate> <!-- Added action/method (though JS overrides) -->
        <!-- Username -->
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" class="form-input" required placeholder="e.g., aditya.01">
            <small class="field-hint">Letters, numbers, underscores, hyphens only.</small>
        </div>

        <!-- Target Groups (Tag Input) -->
        <div class="form-group">
            <label for="group-input-field">Target Groups</label>
            <div class="tag-input-container" id="group-tag-container">
                <ul class="tags-display" id="group-tags-display"></ul>
                <input type="text" id="group-input-field" class="tag-text-input" placeholder="Type or click to select groups...">
                <input type="hidden" name="groups" id="groups-hidden-input">
            </div>
            <ul class="suggestions-list" id="group-suggestions"></ul>
            <small class="field-hint">Select groups to grant access to their associated servers.</small>
        </div>

        <!-- Additional IPs (Tag Input) -->
        <div class="form-group">
            <label for="ip-input-field">Additional Target IPs</label>
            <div class="tag-input-container" id="ip-tag-container">
                 <ul class="tags-display" id="ip-tags-display"></ul>
                <input type="text" id="ip-input-field" class="tag-text-input" placeholder="Enter IP address and press Enter...">
                <input type="hidden" name="ips" id="ips-hidden-input">
            </div>
            <small class="field-hint">Manually specify additional server IPs. Press Enter after each IP.</small>
        </div>

        <!-- Public Key -->
        <div class="form-group">
            <label for="pub_key">Public SSH Key</label>
            <textarea id="pub_key" name="pub_key" class="form-input" rows="6" required placeholder="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ... user@host"></textarea>
            <small class="field-hint">Paste the user's full public SSH key.</small>
        </div>

        <!-- Sudoers Checkbox -->
        <div class="form-group checkbox-group">
            <input type="checkbox" id="add_to_sudoers" name="add_to_sudoers" value="true">
            <label for="add_to_sudoers" class="checkbox-label">Grant Sudo Privileges?</label>
             <small class="field-hint">If checked, the user will be added to the sudoers file (use with caution).</small>
        </div>

        <!-- Submit Button -->
        <div class="form-group submit-group">
            <button type="submit" id="submit-btn" class="access-button primary">
                Grant Access
                <span class="spinner" style="display: none;"></span>
             </button>
        </div>
    </form>

    <!-- Results Area -->
    <div id="results-details" class="results-container" style="display: none;">
        <h2>Processing Results</h2>
        <ul id="results-list"></ul>
    </div>
</div>
{% endblock %}


{% block scripts %}
    <!-- Link the specific JS for this page -->
    <script src="{{ url_for('static', filename='js/giveaccess.js') }}"></script>
{% endblock %}